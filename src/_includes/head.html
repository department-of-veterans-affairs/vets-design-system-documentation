{%- comment %}
  Create a cache-busting string based on build timestamp.
{% endcomment -%}
{%- assign cacheBust = site.time | date:'?v=%s' -%}

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>{% if page.title %}{{ page.title | escape }} - {{ site.title | escape }} {% else %}{{ site.title | escape }}{% endif %}</title>
  <meta name="description" content="{% if page.excerpt %}{{ page.excerpt | strip_html | strip_newlines | truncate: 160 }}{% else %}{{ site.description }}{% endif %}">

  {% if site.analytics == "production" %}
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= 'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-T2ZTDXZ');</script>
  <!-- End Google Tag Manager -->
  {% endif %}

  {% if page.draft %}
  <meta name=”robots” content=”noindex, nofollow”>
  {% endif %}

  <!-- Web component setup -->
  <link rel="stylesheet" type="text/css" href="{{ '/assets/stylesheets/component-library.css' | append: cacheBust }}" />
  <script type="module">
    import { defineCustomElements } from "/vendor/javascripts/component-library/loader/index.es2017.js";
    defineCustomElements();
</script>

  <!-- Icons -->
  <link href="{{ site.baseurl }}/assets/img/favicons/apple-touch-icon.png" rel="apple-touch-icon-precomposed">
  <link href="{{ site.baseurl }}/assets/img/favicons/apple-touch-icon-72x72.png" rel="apple-touch-icon-precomposed" sizes="72x72">
  <link href="{{ site.baseurl }}/assets/img/favicons/apple-touch-icon-114x114.png" rel="apple-touch-icon-precomposed" sizes="114x114">
  <link href="{{ site.baseurl }}/assets/img/favicons/apple-touch-icon-152x152.png" rel="apple-touch-icon-precomposed" sizes="144x144">
  <link rel="shortcut icon" href="{{ site.baseurl }}/assets/img/favicons/favicon.ico">

  <link rel="stylesheet" href="{{ '/assets/stylesheets/application.css' | prepend: site.baseurl | append: cacheBust }}">
  <link rel="canonical" href="{{ page.url | replace:'index.html','' | prepend: site.baseurl | prepend: site.url }}">

  <script src="{{ '/assets/javascripts/polyfills/array.from.js' | prepend: site.baseurl | append: cacheBust }}"></script>

  {% if page.uses_mermaid %}
  <!-- Mermaid Charts -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js" 
          integrity="sha384-WmdflGW9aGfoBdHc4rRyWzYuAjEmDwMdGdiPNacbwfGKxBW/SO6guzuQ76qjnSlr" 
          crossorigin="anonymous"></script>
  <script>
    mermaid.initialize({
      startOnLoad: false,
      theme: 'default',
      securityLevel: 'strict'
    });

    // Render and resize mermaid charts
    document.addEventListener('DOMContentLoaded', function() {
      // Helper function to hide loading overlays
      function hideLoadingOverlays() {
        document.querySelectorAll('.mermaid-loading-overlay').forEach(overlay => {
          overlay.style.display = 'none';
        });
      }
      
      mermaid.run().then(() => {
        const MAX_WIDTH = 528;
        
        document.querySelectorAll('.mermaid svg').forEach(svg => {
          const currentWidth = svg.getAttribute('width') || svg.viewBox?.baseVal?.width || MAX_WIDTH;
          const targetWidth = Math.min(currentWidth, MAX_WIDTH);
          const widthPx = targetWidth + 'px';
          
          // Apply responsive styling - use max-width for mobile scaling
          Object.assign(svg.style, {
            width: '100%',
            height: 'auto',
            maxWidth: widthPx
          });
          
          // Resize mermaid container to be responsive
          const container = svg.closest('.mermaid');
          if (container) {
            Object.assign(container.style, {
              width: '100%',
              maxWidth: widthPx
            });
          }
        });
        
        // Hide loading overlays after charts are rendered
        hideLoadingOverlays();
      }).catch((error) => {
        // Hide loading overlays even if rendering fails
        hideLoadingOverlays();
        
        // Log error for debugging
        console.error('Mermaid chart rendering failed:', error);
      });
    });
  </script>
  {% endif %}
</head>
