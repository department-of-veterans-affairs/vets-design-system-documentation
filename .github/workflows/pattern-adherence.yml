name: Update Pattern Adherence Tracking

on:
  schedule:
    # Run weekly on Mondays at 6 AM UTC (2 AM ET / 1 AM EDT)
    - cron: '0 6 * * 1'
  workflow_dispatch:
    # Allow manual triggering for testing and development

jobs:
  update-pattern-adherence:
    runs-on: ubuntu-latest

    # Skip if last commit was made by GitHub Action
    if: |
      github.event.head_commit.author.email != 'action@github.com' &&
      !contains(github.event.head_commit.message, 'üìä Update pattern adherence data')

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.VADS_WORKFLOWS }}
          ref: ${{ github.head_ref || github.ref_name }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Skip dependency installation
        run: |
          echo "üìù Pattern adherence script uses built-in Node.js modules only"
          echo "üöÄ Skipping yarn install to avoid dependency conflicts"
          echo "‚úÖ Node.js $(node --version) is ready"

      - name: Setup GitHub CLI
        run: |
          echo "Using pre-installed GitHub CLI"
          gh --version
        env:
          GITHUB_TOKEN: ${{ secrets.VADS_WORKFLOWS }}

      - name: Verify GitHub CLI authentication
        run: |
          gh auth status
          gh api user --jq '.login'
        env:
          GITHUB_TOKEN: ${{ secrets.VADS_WORKFLOWS }}

      - name: Checkout vets-website (sparse - src/applications only)
        uses: actions/checkout@v4
        with:
          repository: department-of-veterans-affairs/vets-website
          path: vets-website
          sparse-checkout: |
            src/applications
          sparse-checkout-cone-mode: false
          fetch-depth: 1

      - name: Create data directories
        run: |
          mkdir -p src/assets/data/metrics
          mkdir -p src/_data/metrics

      - name: Collect pattern adherence data
        run: |
          echo "Starting pattern adherence analysis..."
          node scripts/collect-pattern-adherence.js --vets-website-path vets-website
          echo "Pattern adherence analysis completed"
        env:
          GH_TOKEN: ${{ secrets.VADS_WORKFLOWS }}

      - name: Verify generated data files
        run: |
          echo "Checking for generated files..."
          ls -la src/assets/data/metrics/

          if [ -f "src/assets/data/metrics/pattern-adherence.json" ]; then
            echo "‚úÖ pattern-adherence.json generated"
            echo "File size: $(du -h src/assets/data/metrics/pattern-adherence.json)"
          else
            echo "‚ùå pattern-adherence.json not found"
            exit 1
          fi

          if [ -f "src/assets/data/metrics/pattern-adherence-report.md" ]; then
            echo "‚úÖ pattern-adherence-report.md generated"
            echo "File size: $(du -h src/assets/data/metrics/pattern-adherence-report.md)"
          else
            echo "‚ùå pattern-adherence-report.md not found"
            exit 1
          fi

      - name: Check for changes
        id: git-check
        run: |
          git add src/assets/data/metrics/pattern-adherence.json
          git add src/assets/data/metrics/pattern-adherence-report.md
          git add src/_data/metrics/pattern-adherence.json

          if git diff --staged --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
            git diff --staged --stat
          fi

      - name: Create branch and commit changes
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          CURRENT_DATE=$(date -u '+%Y-%m-%d')
          BRANCH_NAME="pattern-adherence-update-${CURRENT_DATE}-${{ github.run_id }}"

          git checkout -b "$BRANCH_NAME"

          TOTAL_PATTERNS=$(jq -r '.total_patterns // "unknown"' src/assets/data/metrics/pattern-adherence.json)
          TOTAL_FORMS=$(jq -r '.total_forms // "unknown"' src/assets/data/metrics/pattern-adherence.json)

          git commit -m "üìä Update pattern adherence data - ${CURRENT_DATE}

          - Analyzed ${TOTAL_PATTERNS} codified patterns
          - Tracked ${TOTAL_FORMS} VA.gov forms
          - Updated pattern-to-forms mapping
          - Generated compliance reports

          ü§ñ Automated update via GitHub Actions"

          git push origin "$BRANCH_NAME"

          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create Pull Request
        if: steps.git-check.outputs.changes == 'true'
        run: |
          CURRENT_DATE=$(date -u '+%Y-%m-%d %H:%M UTC')

          PR_BODY="## Summary
          Automated weekly update of pattern adherence tracking data.

          ### What Changed
          - Pattern-to-forms mapping updated
          - Compliance percentages recalculated
          - Forms √ó Patterns matrix regenerated

          ### Files Updated
          - \`src/assets/data/metrics/pattern-adherence.json\`
          - \`src/assets/data/metrics/pattern-adherence-report.md\`
          - \`src/_data/metrics/pattern-adherence.json\`

          ### Test Plan
          - [ ] Verify JSON structure is valid
          - [ ] Check markdown report renders correctly
          - [ ] Review compliance percentages for accuracy

          ü§ñ Generated with automated workflow - ${CURRENT_DATE}"

          gh pr create \
            --title "üìä Update pattern adherence data - $(date -u '+%Y-%m-%d')" \
            --body "$PR_BODY" \
            --head "$BRANCH_NAME" \
            --base main

          PR_URL=$(gh pr view "$BRANCH_NAME" --json url --jq '.url')
          echo "PR_URL=$PR_URL" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.VADS_WORKFLOWS }}

      - name: Create summary
        if: always()
        run: |
          echo "## üìä Pattern Adherence Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "src/assets/data/metrics/pattern-adherence.json" ]; then
            TOTAL_PATTERNS=$(jq -r '.total_patterns // "unknown"' src/assets/data/metrics/pattern-adherence.json)
            TOTAL_FORMS=$(jq -r '.total_forms // "unknown"' src/assets/data/metrics/pattern-adherence.json)

            echo "### ‚úÖ Pattern Adherence Data Updated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Patterns Analyzed:** ${TOTAL_PATTERNS}" >> $GITHUB_STEP_SUMMARY
            echo "- **Forms Tracked:** ${TOTAL_FORMS}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "${{ steps.git-check.outputs.changes }}" == "true" ]; then
              echo "### üöÄ Pull Request Created" >> $GITHUB_STEP_SUMMARY
              if [ -n "${PR_URL:-}" ]; then
                echo "**PR URL:** $PR_URL" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "### ‚ÑπÔ∏è No Changes" >> $GITHUB_STEP_SUMMARY
              echo "Pattern adherence data is up to date." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### ‚ùå Update Failed" >> $GITHUB_STEP_SUMMARY
            echo "Pattern adherence data was not generated." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìÖ Next Update" >> $GITHUB_STEP_SUMMARY
          echo "Next automatic update: Monday 6 AM UTC" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Pattern adherence workflow failed"
          echo "Check logs for details"
